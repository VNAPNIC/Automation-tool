<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMEW Automation Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .action-card {
            cursor: grab;
            position: relative;
        }

        .action-card:active {
            cursor: grabbing;
        }

        .action-card:hover::after {
            content: attr(data-tooltip-text);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgb(71 85 105);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
        }
        .dark .action-card:hover::after {
            background-color: rgb(51 65 85);
            color: rgb(248 250 252);
        }

        #canvas-container {
            position: relative;
            overflow: hidden;
            background-image:
                radial-gradient(circle, #e2e8f0 1px, transparent 1px),
                radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .dark #canvas-container {
            background-image:
                radial-gradient(circle, #374151 1px, transparent 1px),
                radial-gradient(circle, #374151 1px, transparent 1px);
        }

        #canvas-container.panning,
        #canvas-container.panning .workflow-node {
            cursor: grabbing;
        }

        #canvas-container.pannable,
        #canvas-container.pannable .workflow-node {
            cursor: grab;
        }

        #transform-container {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-origin: 0 0;
        }

        #connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
        }

        .connector-group>* {
            pointer-events: all;
        }

        .connector-path {
            stroke-width: 1.5px;
            fill: none;
            stroke-dasharray: 3 4;
            cursor: pointer;
            transition: stroke-width 0.2s ease;
        }

        .connector-group:hover .connector-path {
            stroke-width: 2.5px;
        }

        .connector-hitbox {
            stroke: transparent;
            stroke-width: 20px;
            fill: none;
            cursor: pointer;
        }

        .connector-path-temp {
            stroke: #3b82f6;
            /* blue-500 */
            stroke-width: 2px;
            stroke-dasharray: 4 4;
            fill: none;
            pointer-events: none;
            transition: stroke 0.1s ease;
        }

        .connector-path-temp.valid-target {
            stroke: #22c55e;
        }

        /* green-500 */
        .connector-path-temp.invalid-target {
            stroke: #ef4444;
        }

        /* red-500 */

        .workflow-node {
            position: absolute;
            width: 220px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: move;
            transition: box-shadow 0.2s, border-color 0.2s;
        }

        .selected-node {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        /* Force header background and text colors - draw.io style */
        header {
            background-color: rgb(250 250 250) !important;
            color: rgb(51 51 51) !important;
            border-color: rgb(224 224 224) !important;
        }
        .dark header {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Force sidebar background colors - draw.io style */
        aside {
            background-color: rgb(250 250 250) !important;
            color: rgb(51 51 51) !important;
            border-color: rgb(224 224 224) !important;
        }
        .dark aside {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Force main section background colors - draw.io style */
        section {
            background-color: rgb(250 250 250) !important;
            color: rgb(51 51 51) !important;
            border-color: rgb(224 224 224) !important;
        }
        .dark section {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Force body background - draw.io style */
        body {
            background-color: rgb(245 245 245) !important;
        }
        .dark body {
            background-color: rgb(20 20 20) !important;
        }
        
        /* Canvas with warm undertones */
        #canvas-container {
            background-color: rgb(255 255 253) !important; /* Very subtle warm white */
        }
        .dark #canvas-container {
            background-color: rgb(25 25 25) !important;
        }
        
        /* Action cards with warm tones */
        .action-card > div {
            background-color: rgb(253 253 251) !important; /* Very light warm */
            color: rgb(45 45 45) !important;
            border-color: rgb(224 219 214) !important; /* Warm border */
        }
        .dark .action-card > div {
            background-color: rgb(40 40 40) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(60 60 60) !important;
        }
        
        /* Fix action cards hover states */
        .action-card > div:hover {
            border-color: rgb(99 102 241) !important;
        }
        .dark .action-card > div:hover {
            border-color: rgb(129 140 248) !important;
        }
        
        /* Workflow nodes with warm tones */
        .workflow-node {
            background-color: rgb(255 255 253) !important; /* Subtle warm white */
            color: rgb(45 45 45) !important;
            border-color: rgb(224 219 214) !important; /* Warm border */
        }
        .dark .workflow-node {
            background-color: rgb(35 35 35) !important;
            color: rgb(220 220 220) !important;
            border-color: rgb(55 55 55) !important;
        }
        
        /* Fix text colors throughout website */
        body, h1, h2, h3, h4, h5, h6, p, span, div, label, summary {
            color: rgb(51 51 51) !important;
        }
        .dark body, .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6, 
        .dark p, .dark span, .dark div, .dark label, .dark summary {
            color: rgb(220 220 220) !important;
        }
        
        /* Fix input and button text colors */
        input, textarea, button {
            color: rgb(51 51 51) !important;
        }
        .dark input, .dark textarea, .dark button {
            color: rgb(220 220 220) !important;
        }
        
        /* Keep button background colors intact but fix text */
        button[class*="bg-"] {
            color: white !important;
        }
        
        /* Draw.io inspired warm color scheme */
        /* Warm off-white backgrounds instead of harsh white */
        body {
            background-color: rgb(251 251 249) !important; /* Very light warm beige */
        }
        .dark body {
            background-color: rgb(15 15 15) !important;
        }
        
        /* Soft cream colored panels */
        header {
            background-color: rgb(254 254 252) !important; /* Warm white */
            border-color: rgb(224 219 214) !important; /* Warm border */
        }
        .dark header {
            background-color: rgb(28 28 28) !important;
            border-color: rgb(48 48 48) !important;
        }
        
        aside {
            background-color: rgb(254 254 252) !important; /* Warm white */
            border-color: rgb(224 219 214) !important;
        }
        .dark aside {
            background-color: rgb(28 28 28) !important;
            border-color: rgb(48 48 48) !important;
        }
        
        section {
            background-color: rgb(254 254 252) !important; /* Warm white */
            border-color: rgb(224 219 214) !important;
        }
        .dark section {
            background-color: rgb(28 28 28) !important;
            border-color: rgb(48 48 48) !important;
        }
        
        /* Fix hover states to be theme aware */
        *[class*="hover:bg-slate-"], *[class*="hover:bg-gray-"] {
            transition: background-color 0.2s !important;
        }
        
        summary:hover, button:hover:not([class*="bg-"]) {
            background-color: rgb(243 244 246) !important;
        }
        .dark summary:hover, .dark button:hover:not([class*="bg-"]) {
            background-color: rgb(55 55 55) !important;
        }
        
        /* Remove annoying line under workflow-node header */
        .node-header {
            border-bottom: none !important;
        }
        
        /* Comprehensive theme overrides - fix everything stuck in dark mode */
        /* Force override all Tailwind dark: classes */
        .dark\:bg-gray-800, .dark\:bg-gray-700, .dark\:bg-gray-600, .dark\:bg-gray-900 {
            background-color: rgb(254 254 252) !important;
        }
        .dark .dark\:bg-gray-800, .dark .dark\:bg-gray-700, .dark .dark\:bg-gray-600, .dark .dark\:bg-gray-900 {
            background-color: rgb(28 28 28) !important;
        }
        
        /* Fix text colors that might be stuck */
        .dark\:text-gray-200, .dark\:text-gray-300, .dark\:text-gray-400, .dark\:text-gray-100 {
            color: rgb(51 51 51) !important;
        }
        .dark .dark\:text-gray-200, .dark .dark\:text-gray-300, .dark .dark\:text-gray-400, .dark .dark\:text-gray-100 {
            color: rgb(220 220 220) !important;
        }
        
        /* Fix border colors */
        .dark\:border-gray-700, .dark\:border-gray-600, .dark\:border-gray-500 {
            border-color: rgb(224 219 214) !important;
        }
        .dark .dark\:border-gray-700, .dark .dark\:border-gray-600, .dark .dark\:border-gray-500 {
            border-color: rgb(48 48 48) !important;
        }
        
        /* Override any remaining Tailwind classes that might be problematic */
        [class*="dark:"] {
            transition: all 0.2s ease !important;
        }
        
        /* Fix specific toggle buttons hover states */
        #language-toggle-button, #theme-toggle-button {
            color: rgb(75 75 75) !important;
        }
        .dark #language-toggle-button, .dark #theme-toggle-button {
            color: rgb(180 180 180) !important;
        }
        
        #language-toggle-button:hover, #theme-toggle-button:hover {
            background-color: rgb(248 246 242) !important; /* Warm hover */
            color: rgb(45 45 45) !important;
        }
        .dark #language-toggle-button:hover, .dark #theme-toggle-button:hover {
            background-color: rgb(45 45 45) !important;
            color: rgb(220 220 220) !important;
        }
        
        /* Fix theme toggle icons visibility */
        .fa-sun {
            display: block !important;
        }
        .dark .fa-sun {
            display: none !important;
        }
        
        .fa-moon {
            display: none !important;
        }
        .dark .fa-moon {
            display: block !important;
        }

        .node-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
        }

        .node-content {
            padding: 0.75rem;
            font-size: 0.875rem;
        }

        .node-port {
            position: absolute;
            width: 14px;
            height: 14px;
            background-color: white;
            border: 2px solid #94a3b8;
            border-radius: 50%;
            cursor: pointer;
            z-index: 15;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .workflow-node:hover .node-port,
        .workflow-node.selected-node .node-port,
        .workflow-node.show-ports .node-port {
            visibility: visible;
            opacity: 1;
        }

        .dark .node-port {
            background-color: #374151;
            border-color: #6b7280;
        }

        .node-port.output-port:hover {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        /* Blue for output */
        .dark .node-port.output-port:hover {
            background-color: #2563eb;
        }

        .node-port.input-port:hover {
            border-color: #16a34a;
            background-color: #dcfce7;
        }

        /* Green for input */
        .dark .node-port.input-port:hover {
            background-color: #166534;
        }

        .port-right {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port-bottom {
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .port-left {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port-top {
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .port-if-then {
            top: 33.33%;
            right: -8px;
            transform: translateY(-50%);
        }

        .port-if-else {
            top: 66.67%;
            right: -8px;
            transform: translateY(-50%);
        }

        .port-label {
            position: absolute;
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
            text-transform: uppercase;
        }

        .label-then {
            right: 12px;
            top: 33.33%;
            transform: translateY(-50%);
        }

        /* green-500 */
        .label-else {
            right: 12px;
            top: 66.67%;
            transform: translateY(-50%);
        }

        /* red-500 */

        .port-tooltip {
            position: absolute;
            background-color: rgb(71 85 105);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .dark .port-tooltip {
            background-color: rgb(51 65 85);
            color: rgb(248 250 252);
        }

        .selected-node .port-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .port-top+.port-tooltip {
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
        }

        .port-bottom+.port-tooltip {
            top: 105%;
            left: 50%;
            transform: translateX(-50%) translateY(6px);
        }

        .port-left+.port-tooltip {
            right: 102%;
            top: 50%;
            transform: translateY(-50%) translateX(-6px);
        }

        .port-right+.port-tooltip {
            left: 102%;
            top: 50%;
            transform: translateY(-50%) translateX(6px);
        }

        .port-if-then+.port-tooltip {
            left: 102%;
            top: 33.33%;
            transform: translateY(-50%) translateX(6px);
        }

        .port-if-else+.port-tooltip {
            left: 102%;
            top: 66.67%;
            transform: translateY(-50%) translateX(6px);
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] .details-marker {
            transform: rotate(90deg);
        }

        /* Áp dụng cho các trình duyệt WebKit (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Dark mode scrollbar for WebKit */
        .dark ::-webkit-scrollbar-track {
            background: rgb(55 65 81);
        }
        .dark ::-webkit-scrollbar-thumb {
            background: rgb(107 114 128);
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgb(156 163 175);
        }
        /* Áp dụng cho Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f1f5f9;
        }
        .dark * {
            scrollbar-color: rgb(107 114 128) rgb(55 65 81);
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-gray-200 h-screen flex flex-col overflow-hidden">

    <header class="bg-white dark:bg-gray-800 border-b border-slate-200 dark:border-gray-700 z-20 flex-shrink-0">
        <div class="px-4 py-2 flex justify-between items-center">
            <h1 class="text-lg font-bold text-slate-900 dark:text-gray-100"><i class="fas fa-sitemap text-blue-600"></i>
                SMEW Automation Builder</h1>
            <div class="flex items-center space-x-2">
                <button id="test-button"
                    class="bg-green-500 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-green-600 transition-colors active:scale-95 text-sm disabled:opacity-50 disabled:cursor-not-allowed"><i
                        class="fas fa-play mr-2"></i>Test</button>
                <button id="import-button"
                    class="bg-sky-500 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-sky-600 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-upload mr-2"></i>Import</button>
                <input type="file" id="import-file" class="hidden" accept=".json">
                <button id="export-button"
                    class="bg-slate-700 text-white font-semibold px-3 py-1.5 rounded-md hover:bg-slate-800 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-download mr-2"></i>Export</button>
                <button id="clear-button"
                    class="bg-red-500 text-white font-semibold px-2.5 py-1.5 rounded-md hover:bg-red-600 transition-colors active:scale-95 text-sm"><i
                        class="fas fa-trash"></i></button>
                <button id="language-toggle-button"
                    class="text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-md p-1.5 transition-colors mr-2">
                    <span id="current-lang" class="font-semibold">EN</span>
                </button>
                <button id="theme-toggle-button"
                    class="text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-gray-700 rounded-md p-1.5 transition-colors">
                    <i class="fas fa-sun block dark:hidden"></i>
                    <i class="fas fa-moon hidden dark:block"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 grid grid-cols-1 lg:grid-cols-12 gap-4" style="min-height: 0;">

        <aside
            class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg border border-slate-200 dark:border-gray-700 p-2 flex flex-col overflow-hidden">
            <div class="flex-grow min-h-0 overflow-y-auto pr-1">
                <details open class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Logic
                    </summary>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <div class="action-card" draggable="true" data-action-type="if" data-tooltip-text="Điều Kiện">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-indigo-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-code-branch text-indigo-500 dark:text-indigo-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="forEach"
                            data-tooltip-text="Vòng Lặp">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-sync-alt text-purple-500 dark:text-purple-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="setVariable"
                            data-tooltip-text="Gán Biến">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-pink-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-equals text-pink-500 dark:text-pink-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="stop" data-tooltip-text="Dừng">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-stop-circle text-red-500 dark:text-red-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="comment"
                            data-tooltip-text="Ghi Chú">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-comment-dots text-gray-500 dark:text-gray-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details open class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Điều Hướng
                    </summary>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <div class="action-card" draggable="true" data-action-type="goto"
                            data-tooltip-text="Truy cập URL">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-sky-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-link text-sky-500 dark:text-sky-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="reload"
                            data-tooltip-text="Tải Lại Trang">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-redo text-green-500 dark:text-green-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="goBack"
                            data-tooltip-text="Lùi Lại Trang">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-slate-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-arrow-left text-slate-500 dark:text-slate-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="goForward"
                            data-tooltip-text="Tới Trang Trước">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-slate-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-arrow-right text-slate-500 dark:text-slate-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details open class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Tương Tác
                    </summary>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <div class="action-card" draggable="true" data-action-type="click" data-tooltip-text="Nhấp">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-amber-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-hand-pointer text-amber-500 dark:text-amber-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="fill" data-tooltip-text="Điền">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-violet-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-keyboard text-violet-500 dark:text-violet-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="clearInput"
                            data-tooltip-text="Xóa Ô Nhập Liệu">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-red-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-eraser text-red-500 dark:text-red-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="setCheckboxState"
                            data-tooltip-text="Trạng thái Checkbox">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-check-square text-blue-500 dark:text-blue-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="selectOption"
                            data-tooltip-text="Chọn Dropdown">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-orange-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-list-ul text-orange-500 dark:text-orange-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="hover"
                            data-tooltip-text="Di chuột qua">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-cyan-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-mouse-pointer text-cyan-500 dark:text-cyan-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="press"
                            data-tooltip-text="Nhấn Phím">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-teal-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-arrow-turn-down text-teal-500 dark:text-teal-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="uploadFile"
                            data-tooltip-text="Tải Lên Tệp">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-fuchsia-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-file-upload text-fuchsia-500 dark:text-fuchsia-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Chờ Đợi
                    </summary>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <div class="action-card" draggable="true" data-action-type="waitTimeout"
                            data-tooltip-text="Chờ Thời Gian">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-clock text-gray-500 dark:text-gray-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="waitElement"
                            data-tooltip-text="Chờ Phần Tử">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-blue-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-binoculars text-blue-500 dark:text-blue-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Trích Xuất
                    </summary>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <div class="action-card" draggable="true" data-action-type="getText"
                            data-tooltip-text="Lấy Văn bản">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-rose-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-quote-left text-rose-500 dark:text-rose-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="getAttribute"
                            data-tooltip-text="Lấy Thuộc tính">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-lime-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-at text-lime-500 dark:text-lime-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="getInputValue"
                            data-tooltip-text="Lấy Giá trị Input">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-purple-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-i-cursor text-purple-500 dark:text-purple-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="screenshot"
                            data-tooltip-text="Chụp Ảnh">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-gray-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-camera text-gray-500 dark:text-gray-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="text-slate-800 dark:text-gray-200">
                    <summary
                        class="cursor-pointer p-2 font-semibold hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md">
                        <i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>Kiểm Tra
                    </summary>
                    <div class="grid grid-cols-3 gap-2 p-2">
                        <div class="action-card" draggable="true" data-action-type="assertVisible"
                            data-tooltip-text="Kiểm tra Hiển thị">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-green-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-eye text-green-500 dark:text-green-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="action-card" draggable="true" data-action-type="assertText"
                            data-tooltip-text="Kiểm tra Văn bản">
                            <div
                                class="bg-slate-50 dark:bg-gray-700 p-2 rounded-md border border-slate-200 dark:border-gray-600 hover:border-yellow-400 aspect-square flex items-center justify-center">
                                <i class="fas fa-check-double text-yellow-500 dark:text-yellow-400 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </aside>

        <section
            class="lg:col-span-7 bg-white dark:bg-gray-800 rounded-lg border border-slate-200 dark:border-gray-700 flex flex-col p-0">
            <div id="canvas-container" class="flex-grow rounded-b-lg bg-slate-50 dark:bg-gray-900/50">
                <div id="transform-container">
                    <div id="node-container"></div>
                    <svg id="connection-svg">
                        <defs>
                            <marker id="end-circle" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-green-500" />
                            </marker>
                            <marker id="end-circle-temp" markerWidth="12" markerHeight="12" refX="6" refY="6"
                                orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-blue-600" />
                            </marker>
                            <marker id="end-circle-valid" markerWidth="12" markerHeight="12" refX="6" refY="6"
                                orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-green-500" />
                            </marker>
                            <marker id="end-circle-invalid" markerWidth="12" markerHeight="12" refX="6" refY="6"
                                orient="auto">
                                <circle cx="6" cy="6" r="4" class="fill-red-500" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </section>

        <aside id="right-sidebar"
            class="lg:col-span-3 bg-white dark:bg-gray-800 rounded-lg border border-slate-200 dark:border-gray-700 p-4 flex flex-col">
            <div id="properties-panel-container" class="flex flex-col h-full">
                <h2
                    class="text-lg font-semibold mb-4 pb-2 border-b border-slate-200 dark:border-gray-700 text-slate-900 dark:text-gray-100">
                    <i class="fas fa-sliders-h mr-2 text-slate-500 dark:text-gray-400"></i>Thuộc tính
                </h2>
                <div id="properties-panel" class="flex-grow overflow-y-auto">
                    <p class="text-slate-500 dark:text-gray-400 text-center mt-8">Chọn một khối để xem thuộc tính.</p>
                </div>
            </div>
        </aside>
    </main>

    <!-- Element Selector Modal -->
    <div id="selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-slate-200 dark:border-gray-700">
            <div class="p-4 border-b border-slate-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-gray-100"><i
                        class="fas fa-crosshairs mr-2 text-blue-500"></i>Công Cụ Chọn Phần Tử</h3>
                <button id="close-selector-modal"
                    class="text-slate-500 dark:text-gray-400 hover:text-slate-800 dark:hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">URL trang web mục
                        tiêu</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="selector-url-input"
                            class="flex-grow px-3 py-2 border border-slate-300 dark:border-gray-600 bg-slate-50 dark:bg-gray-700 text-slate-800 dark:text-gray-200 rounded-md"
                            readonly>
                        <button id="open-url-btn"
                            class="bg-blue-500 text-white font-semibold px-3 py-2 rounded-md hover:bg-blue-600 transition-colors active:scale-95 text-sm"><i
                                class="fas fa-external-link-alt mr-2"></i>Mở Tab</button>
                    </div>
                    <p id="url-not-found-msg" class="text-sm text-red-500 mt-1 hidden">Không tìm thấy hành động "Truy
                        cập URL" trước đó. Vui lòng thêm vào luồng công việc.</p>
                </div>

                <div
                    class="bg-slate-50 dark:bg-gray-900/50 p-4 rounded-md border border-slate-200 dark:border-gray-700">
                    <h4 class="font-semibold mb-2 text-slate-800 dark:text-gray-200">Hướng dẫn:</h4>
                    <ol class="list-decimal list-inside space-y-2 text-sm text-slate-600 dark:text-gray-400">
                        <li>Nhấn nút "Mở Tab" để xem trang web trong một tab mới.</li>
                        <li>Trên tab mới, **nhấp chuột phải** vào phần tử bạn muốn chọn (ví dụ: nút bấm, ô nhập liệu).
                        </li>
                        <li>Từ menu ngữ cảnh, chọn **"Inspect"** (Kiểm tra).</li>
                        <li>Trong bảng điều khiển (DevTools) vừa mở ra, nhấp chuột phải vào dòng code HTML được tô sáng.
                        </li>
                        <li>Đi đến **Copy** &rarr; **Copy selector**.</li>
                        <li>Quay lại đây và dán bộ chọn vào ô bên dưới.</li>
                    </ol>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">Dán bộ chọn
                        (selector) vào đây</label>
                    <textarea id="selector-paste-area" rows="2"
                        class="w-full px-3 py-2 border border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-slate-800 dark:text-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="CSS Selector sẽ được dán vào đây..."></textarea>
                </div>
            </div>
            <div
                class="p-4 border-t border-slate-200 dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50 flex justify-end">
                <button id="confirm-selector-btn"
                    class="bg-green-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-green-600 transition-colors active:scale-95"><i
                        class="fas fa-check mr-2"></i>Xác nhận lựa chọn</button>
            </div>
        </div>
    </div>

    <script>

        const translations = {
            en: {
                title: "SMEW Automation Builder",
                test: "Test",
                import: "Import",
                export: "Export",
                logic: "Logic",
                navigation: "Navigation",
                interaction: "Interaction",
                wait: "Wait",
                extract: "Extract",
                verify: "Verify",
                properties: "Properties",
                selectBlockToView: "Select a block to view properties.",

                condition: "Condition",
                loop: "Loop",
                setVariable: "Set Variable",
                stop: "Stop",
                comment: "Comment",
                gotoURL: "Go to URL",
                reload: "Reload Page",
                goBack: "Go Back",
                goForward: "Go Forward",
                click: "Click",
                fill: "Fill",
                clearInput: "Clear Input",
                checkboxState: "Checkbox State",
                selectOption: "Select Dropdown",
                hover: "Hover",
                keyPress: "Key Press",
                uploadFile: "Upload File",
                waitTime: "Wait Time",
                waitElement: "Wait Element",
                getText: "Get Text",
                getAttribute: "Get Attribute",
                getInputValue: "Get Input Value",
                screenshot: "Screenshot",
                assertVisible: "Assert Visible",
                assertText: "Assert Text",

                start: "Start",

                input: "Input",
                output: "Output",
                then: "Then",
                else: "Else",
                next: "Next",
                loopBody: "Loop Body"
            },
            vi: {
                title: "SMEW Automation Builder",
                test: "Test",
                import: "Import",
                export: "Export",
                logic: "Logic",
                navigation: "Điều Hướng",
                interaction: "Tương Tác",
                wait: "Chờ Đợi",
                extract: "Trích Xuất",
                verify: "Kiểm Tra",
                properties: "Thuộc tính",
                selectBlockToView: "Chọn một khối để xem thuộc tính.",

                condition: "Điều Kiện",
                loop: "Vòng Lặp",
                setVariable: "Gán Biến",
                stop: "Dừng",
                comment: "Ghi Chú",
                gotoURL: "Truy cập URL",
                reload: "Tải Lại Trang",
                goBack: "Lùi Lại Trang",
                goForward: "Tới Trang Trước",
                click: "Nhấp",
                fill: "Điền",
                clearInput: "Xóa Ô Nhập Liệu",
                checkboxState: "Trạng thái Checkbox",
                selectOption: "Chọn Dropdown",
                hover: "Di chuột qua",
                keyPress: "Nhấn Phím",
                uploadFile: "Tải Lên Tệp",
                waitTime: "Chờ Thời Gian",
                waitElement: "Chờ Phần Tử",
                getText: "Lấy Văn bản",
                getAttribute: "Lấy Thuộc tính",
                getInputValue: "Lấy Giá trị Input",
                screenshot: "Chụp Ảnh",
                assertVisible: "Kiểm tra Hiển thị",
                assertText: "Kiểm tra Văn bản",

                start: "Bắt đầu",

                input: "Đầu vào",
                output: "Đầu ra",
                then: "Then",
                else: "Else",
                next: "Tiếp theo",
                loopBody: "Vòng lặp"
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en';

        function updateLanguage() {
            const lang = translations[currentLanguage];
            document.getElementById('current-lang').textContent = currentLanguage.toUpperCase();
            document.documentElement.lang = currentLanguage;


            document.querySelector('h1').innerHTML = `<i class="fas fa-sitemap text-blue-600"></i> ${lang.title}`;


            document.getElementById('test-button').innerHTML = `<i class="fas fa-play mr-2"></i>${lang.test}`;
            document.getElementById('import-button').innerHTML = `<i class="fas fa-upload mr-2"></i>${lang.import}`;
            document.getElementById('export-button').innerHTML = `<i class="fas fa-download mr-2"></i>${lang.export}`;


            const tooltipMapping = {
                'if': lang.condition,
                'forEach': lang.loop,
                'setVariable': lang.setVariable,
                'stop': lang.stop,
                'comment': lang.comment,
                'goto': lang.gotoURL,
                'reload': lang.reload,
                'goBack': lang.goBack,
                'goForward': lang.goForward,
                'click': lang.click,
                'fill': lang.fill,
                'clearInput': lang.clearInput,
                'setCheckboxState': lang.checkboxState,
                'selectOption': lang.selectOption,
                'hover': lang.hover,
                'press': lang.keyPress,
                'uploadFile': lang.uploadFile,
                'waitTimeout': lang.waitTime,
                'waitElement': lang.waitElement,
                'getText': lang.getText,
                'getAttribute': lang.getAttribute,
                'getInputValue': lang.getInputValue,
                'screenshot': lang.screenshot,
                'assertVisible': lang.assertVisible,
                'assertText': lang.assertText
            };


            Object.keys(tooltipMapping).forEach(actionType => {
                document.querySelectorAll(`[data-action-type="${actionType}"]`).forEach(card => {
                    card.setAttribute('data-tooltip-text', tooltipMapping[actionType]);
                });
            });


            document.querySelectorAll('details summary').forEach(summary => {
                const icon = summary.querySelector('i');
                const text = summary.textContent.trim();
                if (text.includes('Logic')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.logic}`;
                } else if (text.includes('Điều Hướng') || text.includes('Navigation')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.navigation}`;
                } else if (text.includes('Tương Tác') || text.includes('Interaction')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.interaction}`;
                } else if (text.includes('Chờ Đợi') || text.includes('Wait')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.wait}`;
                } else if (text.includes('Trích Xuất') || text.includes('Extract')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.extract}`;
                } else if (text.includes('Kiểm Tra') || text.includes('Verify')) {
                    summary.innerHTML = `<i class="fas fa-chevron-right inline-block mr-2 text-xs details-marker"></i>${lang.verify}`;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const languageToggleButton = document.getElementById('language-toggle-button');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const htmlEl = document.documentElement;

            const applyTheme = (isDark) => {
                htmlEl.classList.toggle('dark', isDark);
                localStorage.theme = isDark ? 'dark' : 'light';
            };

            languageToggleButton.addEventListener('click', () => {
                currentLanguage = currentLanguage === 'en' ? 'vi' : 'en';
                localStorage.setItem('language', currentLanguage);
                updateLanguage();
                renderAll();
            });

            themeToggleButton.addEventListener('click', () => applyTheme(!htmlEl.classList.contains('dark')));
            applyTheme(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));


            updateLanguage();

            let nodes = [];
            let connections = [];
            let selectedNodeId = null;
            let dragInfo = {};
            let tempConnection = { active: false, startNode: null, startPort: null, path: null };
            let scale = 1, panX = 0, panY = 0, isPanning = false, isSpacePressed = false, panStart = { x: 0, y: 0 };
            let isTesting = false;
            let isTestStopped = false;
            let activeSelectorInputId = null;

            const canvasContainer = document.getElementById('canvas-container');
            const transformContainer = document.getElementById('transform-container');
            const nodeContainer = document.getElementById('node-container');
            const svg = document.getElementById('connection-svg');
            const propertiesPanelContainer = document.getElementById('properties-panel-container');
            const clearButton = document.getElementById('clear-button');
            const exportButton = document.getElementById('export-button');
            const importButton = document.getElementById('import-button');
            const importFileInput = document.getElementById('import-file');
            const testButton = document.getElementById('test-button');


            const selectorModal = document.getElementById('selector-modal');
            const closeSelectorModalBtn = document.getElementById('close-selector-modal');
            const selectorUrlInput = document.getElementById('selector-url-input');
            const openUrlBtn = document.getElementById('open-url-btn');
            const urlNotFoundMsg = document.getElementById('url-not-found-msg');
            const selectorPasteArea = document.getElementById('selector-paste-area');
            const confirmSelectorBtn = document.getElementById('confirm-selector-btn');

            const getActionConfig = () => {
                const lang = translations[currentLanguage];
                return {
                    'start': { icon: 'fa-play-circle text-green-500 dark:text-green-400', name: lang.start, params: [] },
                    'if': { icon: 'fa-code-branch text-indigo-500 dark:text-indigo-400', name: lang.condition, params: [{ id: 'condition', label: currentLanguage === 'vi' ? 'Điều kiện' : 'Condition', type: 'text', placeholder: currentLanguage === 'vi' ? 'biến == "giá trị"' : 'variable == "value"' }] },
                    'forEach': { icon: 'fa-sync-alt text-purple-500 dark:text-purple-400', name: lang.loop, params: [{ id: 'list', label: currentLanguage === 'vi' ? 'Mảng hoặc Số Lần' : 'Array or Count', type: 'text', placeholder: 'myArray | 5' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Biến phần tử' : 'Item Variable', type: 'text', placeholder: 'item' }] },
                    'setVariable': { icon: 'fa-equals text-pink-500 dark:text-pink-400', name: lang.setVariable, params: [{ id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'myVar' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: '"Hello World!"' }] },
                    'stop': { icon: 'fa-stop-circle text-red-500 dark:text-red-400', name: lang.stop, params: [] },
                    'comment': { icon: 'fa-comment-dots text-gray-500 dark:text-gray-400', name: lang.comment, params: [{ id: 'text', label: currentLanguage === 'vi' ? 'Nội dung' : 'Content', type: 'text', placeholder: currentLanguage === 'vi' ? 'Ghi chú ở đây...' : 'Comment here...' }] },
                    'goto': { icon: 'fa-link text-sky-500 dark:text-sky-400', name: lang.gotoURL, params: [{ id: 'url', label: 'URL', type: 'text', placeholder: 'https://example.com' }] },
                    'reload': { icon: 'fa-redo text-green-500 dark:text-green-400', name: lang.reload, params: [] },
                    'goBack': { icon: 'fa-arrow-left text-slate-500 dark:text-slate-400', name: lang.goBack, params: [] },
                    'goForward': { icon: 'fa-arrow-right text-slate-500 dark:text-slate-400', name: lang.goForward, params: [] },
                    'click': { icon: 'fa-hand-pointer text-amber-500 dark:text-amber-400', name: lang.click, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.btn-primary' }, { id: 'type', label: currentLanguage === 'vi' ? 'Loại Click' : 'Click Type', type: 'select', options: [{ value: 'left', text: currentLanguage === 'vi' ? 'Trái' : 'Left' }, { value: 'right', text: currentLanguage === 'vi' ? 'Phải' : 'Right' }, { value: 'double', text: 'Double Click' }] }] },
                    'fill': { icon: 'fa-keyboard text-violet-500 dark:text-violet-400', name: lang.fill, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#username' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: currentLanguage === 'vi' ? 'Nhập giá trị...' : 'Enter value...' }] },
                    'clearInput': { icon: 'fa-eraser text-red-500 dark:text-red-400', name: lang.clearInput, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#search' }] },
                    'setCheckboxState': { icon: 'fa-check-square text-blue-500 dark:text-blue-400', name: lang.checkboxState, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#terms' }, { id: 'state', label: currentLanguage === 'vi' ? 'Trạng thái' : 'State', type: 'select', options: [{ value: 'check', text: 'Check' }, { value: 'uncheck', text: 'Uncheck' }] }] },
                    'selectOption': { icon: 'fa-list-ul text-orange-500 dark:text-orange-400', name: lang.selectOption, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#country' }, { id: 'value', label: currentLanguage === 'vi' ? 'Giá trị' : 'Value', type: 'text', placeholder: 'Vietnam' }] },
                    'hover': { icon: 'fa-mouse-pointer text-cyan-500 dark:text-cyan-400', name: lang.hover, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.menu-item' }] },
                    'press': { icon: 'fa-arrow-down-to-bracket text-teal-500 dark:text-teal-400', name: lang.keyPress, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'input[name="q"]' }, { id: 'key', label: currentLanguage === 'vi' ? 'Phím' : 'Key', type: 'text', placeholder: 'Enter' }] },
                    'uploadFile': { icon: 'fa-file-upload text-fuchsia-500 dark:text-fuchsia-400', name: lang.uploadFile, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'input[type="file"]' }, { id: 'filePath', label: currentLanguage === 'vi' ? 'Đường dẫn tệp' : 'File Path', type: 'text', placeholder: 'C:\\Users\\...\\file.txt' }] },
                    'waitTimeout': { icon: 'fa-clock text-gray-500 dark:text-gray-400', name: lang.waitTime, params: [{ id: 'timeout', label: currentLanguage === 'vi' ? 'Thời gian (ms)' : 'Time (ms)', type: 'number', placeholder: '1000' }] },
                    'waitElement': { icon: 'fa-binoculars text-blue-500 dark:text-blue-400', name: lang.waitElement, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#loading-spinner' }] },
                    'getText': { icon: 'fa-quote-left text-rose-500 dark:text-rose-400', name: lang.getText, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'h1' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'pageTitle' }] },
                    'getAttribute': { icon: 'fa-at text-lime-500 dark:text-lime-400', name: lang.getAttribute, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'a.product' }, { id: 'attribute', label: currentLanguage === 'vi' ? 'Tên thuộc tính' : 'Attribute Name', type: 'text', placeholder: 'href' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'productUrl' }] },
                    'getInputValue': { icon: 'fa-i-cursor text-purple-500 dark:text-purple-400', name: lang.getInputValue, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '#firstname' }, { id: 'variable', label: currentLanguage === 'vi' ? 'Tên biến' : 'Variable Name', type: 'text', placeholder: 'firstName' }] },
                    'screenshot': { icon: 'fa-camera text-gray-500 dark:text-gray-400', name: lang.screenshot, params: [{ id: 'filename', label: currentLanguage === 'vi' ? 'Tên tệp' : 'Filename', type: 'text', placeholder: 'screenshot.png' }, { id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn (tùy chọn)' : 'Selector (optional)', type: 'selector', placeholder: currentLanguage === 'vi' ? 'Chụp 1 phần tử' : 'Capture element' }] },
                    'assertVisible': { icon: 'fa-eye text-green-500 dark:text-green-400', name: lang.assertVisible, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: '.welcome-message' }] },
                    'assertText': { icon: 'fa-check-double text-yellow-500 dark:text-yellow-400', name: lang.assertText, params: [{ id: 'selector', label: currentLanguage === 'vi' ? 'Bộ chọn' : 'Selector', type: 'selector', placeholder: 'h1' }, { id: 'text', label: currentLanguage === 'vi' ? 'Văn bản mong muốn' : 'Expected Text', type: 'text', placeholder: currentLanguage === 'vi' ? 'Chào mừng' : 'Welcome' }] }
                };
            };

            function createNode(type, x, y) {
                const id = `node_${Date.now()}${Math.floor(Math.random() * 1000)}`;
                const node = { id, type, x, y, params: {} };
                const actionConfig = getActionConfig();
                if (actionConfig[type] && actionConfig[type].params) {
                    actionConfig[type].params.forEach(p => {
                        node.params[p.id] = p.options ? p.options[0].value : '';
                    });
                }
                return node;
            }

            const getPortTooltips = () => {
                const lang = translations[currentLanguage];
                return {
                    'in': lang.input,
                    'out': lang.output,
                    'then': lang.then,
                    'else': lang.else,
                    'next': lang.next,
                    'loopBody': lang.loopBody,
                    'in_top': lang.input,
                    'in_left': lang.input,
                    'out_right': lang.output,
                    'out_bottom': lang.output,
                };
            };
            const createPortWithTooltip = (position, type, name) => {
                const portTooltips = getPortTooltips();
                const tooltipText = portTooltips[name] || name;
                return `<div class="node-port ${position} ${type}-port" data-port-name="${name}"></div><span class="port-tooltip">${tooltipText}</span>`;
            };

            function renderNodes() {
                nodeContainer.innerHTML = '';
                nodes.forEach(node => {
                    const actionConfig = getActionConfig();
                    const config = actionConfig[node.type];
                    if (!config) return;
                    const el = document.createElement('div');
                    el.id = node.id;
                    const isSelected = node.id === selectedNodeId;
                    el.className = `workflow-node bg-white dark:bg-gray-700 border border-slate-200 dark:border-gray-600 text-slate-800 dark:text-gray-200 ${isSelected ? 'selected-node' : ''}`;
                    el.style.left = `${node.x}px`;
                    el.style.top = `${node.y}px`;

                    let contentHTML = `<div class="node-header border-b border-slate-200 dark:border-gray-600"><i class="fas ${config.icon} mr-2"></i>${config.name}</div>`;
                    if (config.params.length > 0) {
                        const summary = Object.values(node.params).find(v => v) || 'Chưa cấu hình';
                        contentHTML += `<div class="node-content text-slate-600 dark:text-gray-400 text-xs truncate"><strong>${config.params[0].label}:</strong> ${summary}</div>`;
                    }
                    el.innerHTML = contentHTML;

                    let portsHTML = '';
                    let labelsHTML = '';

                    switch (node.type) {
                        case 'start':
                            portsHTML = createPortWithTooltip('port-right', 'output', 'out');
                            break;
                        case 'stop':
                            portsHTML = createPortWithTooltip('port-left', 'input', 'in');
                            break;
                        case 'comment':
                            portsHTML = '';
                            break;
                        case 'if':
                            portsHTML = `${createPortWithTooltip('port-left', 'input', 'in')}${createPortWithTooltip('port-if-then', 'output', 'then')}${createPortWithTooltip('port-if-else', 'output', 'else')}`;
                            labelsHTML = `<span class="port-label label-then text-green-500">THEN</span><span class="port-label label-else text-red-500">ELSE</span>`;
                            break;
                        case 'forEach':
                            portsHTML = `${createPortWithTooltip('port-left', 'input', 'in')}${createPortWithTooltip('port-right', 'output', 'next')}${createPortWithTooltip('port-bottom', 'output', 'loopBody')}`;
                            labelsHTML = `<span class="port-label text-green-500" style="top: 50%; right: 14px; transform: translateY(-50%);">NEXT</span><span class="port-label text-purple-500" style="bottom: -24px; left: 50%; transform: translateX(-50%);">LOOP</span>`;
                            break;
                        default:
                            portsHTML = `${createPortWithTooltip('port-top', 'input', 'in_top')}${createPortWithTooltip('port-left', 'input', 'in_left')}${createPortWithTooltip('port-right', 'output', 'out_right')}${createPortWithTooltip('port-bottom', 'output', 'out_bottom')}`;
                            break;
                    }
                    el.innerHTML += portsHTML + labelsHTML;

                    el.addEventListener('mousedown', e => onNodeMouseDown(e, node));
                    el.querySelectorAll('.node-port').forEach(p => p.addEventListener('mousedown', onPortMouseDown));
                    nodeContainer.appendChild(el);
                });
            }

            function drawCurve(x1, y1, x2, y2) {
                const handleOffset = Math.max(50, Math.abs(x2 - x1) * 0.4);
                return `M ${x1},${y1} C ${x1 + handleOffset},${y1} ${x2 - handleOffset},${y2} ${x2},${y2}`;
            }

            function getPortPosition(nodeId, portName) {
                const portEl = document.querySelector(`#${nodeId} [data-port-name="${portName}"]`);
                if (!portEl) return null;
                const node = nodes.find(n => n.id === nodeId);
                if (!node) return null;


                const nodeWidth = 220;


                const actionConfig = getActionConfig();
                const config = actionConfig[node.type];
                let nodeHeight = 40;
                if (config && config.params && config.params.length > 0) {
                    nodeHeight += 44;
                }

                let portOffsetX = 0;
                let portOffsetY = 0;



                if (portEl.classList.contains('port-left')) {
                    portOffsetX = 0;
                    portOffsetY = nodeHeight / 2;
                } else if (portEl.classList.contains('port-right')) {
                    portOffsetX = nodeWidth;
                    portOffsetY = nodeHeight / 2;
                } else if (portEl.classList.contains('port-top')) {
                    portOffsetX = nodeWidth / 2;
                    portOffsetY = 0;
                } else if (portEl.classList.contains('port-bottom')) {
                    portOffsetX = nodeWidth / 2;
                    portOffsetY = nodeHeight;
                } else if (portEl.classList.contains('port-if-then')) {
                    portOffsetX = nodeWidth;
                    portOffsetY = nodeHeight * 0.33;
                } else if (portEl.classList.contains('port-if-else')) {
                    portOffsetX = nodeWidth;
                    portOffsetY = nodeHeight * 0.67;
                }

                return {
                    x: node.x + portOffsetX,
                    y: node.y + portOffsetY
                };
            }

            function renderConnections() {

                const defs = svg.querySelector('defs');
                svg.innerHTML = '';
                if (defs) svg.appendChild(defs);

                connections.forEach((conn, index) => {
                    const startPos = getPortPosition(conn.fromNode, conn.fromPort);
                    const endPos = getPortPosition(conn.toNode, conn.toPort);
                    if (!startPos || !endPos) return;

                    const d = drawCurve(startPos.x, startPos.y, endPos.x, endPos.y);
                    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    group.classList.add('connector-group');
                    group.setAttribute('data-connection-index', index);


                    if (dragInfo.type === 'connection_active' && dragInfo.index === index) {
                        group.style.display = 'none';
                    }

                    const hitbox = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    hitbox.setAttribute('d', d);
                    hitbox.classList.add('connector-hitbox');

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', d);
                    path.classList.add('connector-path', 'stroke-slate-400', 'dark:stroke-gray-500');
                    path.setAttribute('marker-end', 'url(#end-circle)');

                    group.appendChild(hitbox);
                    group.appendChild(path);
                    group.addEventListener('mousedown', (e) => onConnectionPathMouseDown(e, conn, index));
                    group.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        connections.splice(index, 1);
                        renderAll();
                    });
                    svg.appendChild(group);
                });


                if (tempConnection.path && tempConnection.path.parentNode !== svg) {
                    svg.appendChild(tempConnection.path);
                }
            }

            function onMouseMove(e) {
                if (dragInfo.type === 'connection') {
                    const dx = e.clientX - dragInfo.startX;
                    const dy = e.clientY - dragInfo.startY;
                    if (Math.sqrt(dx * dx + dy * dy) > 3) {
                        dragInfo.type = 'connection_active';
                        tempConnection.active = true;
                        tempConnection.startNode = dragInfo.connection.fromNode;
                        tempConnection.startPort = dragInfo.connection.fromPort;
                        const startPos = getPortPosition(tempConnection.startNode, tempConnection.startPort);
                        if (startPos) {

                            if (tempConnection.path) {
                                tempConnection.path.remove();
                            }
                            tempConnection.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            tempConnection.path.setAttribute('d', drawCurve(startPos.x, startPos.y, startPos.x, startPos.y));
                            tempConnection.path.classList.add('connector-path-temp');
                            tempConnection.path.setAttribute('marker-end', 'url(#end-circle-temp)');
                            tempConnection.path.style.pointerEvents = 'none';
                            svg.appendChild(tempConnection.path);
                            renderConnections();
                        }
                    }
                }
                if (dragInfo.type === 'node') {
                    const rect = canvasContainer.getBoundingClientRect();
                    dragInfo.target.x = (e.clientX - rect.left - panX) / scale - dragInfo.offsetX;
                    dragInfo.target.y = (e.clientY - rect.top - panY) / scale - dragInfo.offsetY;
                    renderAll();
                }
                if (isPanning) {
                    panX += e.clientX - panStart.x;
                    panY += e.clientY - panStart.y;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                    applyTransform();
                }
                if (tempConnection.active && tempConnection.path) {

                    document.querySelectorAll('.workflow-node').forEach(node => {
                        node.classList.add('show-ports');
                    });

                    const startPos = getPortPosition(tempConnection.startNode, tempConnection.startPort);
                    if (!startPos) return;
                    const canvasRect = canvasContainer.getBoundingClientRect();
                    const endX = (e.clientX - canvasRect.left - panX) / scale;
                    const endY = (e.clientY - canvasRect.top - panY) / scale;


                    tempConnection.path.setAttribute('d', drawCurve(startPos.x, startPos.y, endX, endY));


                    const endPort = e.target.closest('.node-port');
                    tempConnection.path.classList.remove('valid-target', 'invalid-target');
                    let isValidTarget = false;

                    if (endPort && window.getComputedStyle(endPort).visibility === 'visible') {
                        const endNodeId = endPort.closest('.workflow-node').id;
                        const isInputPort = endPort.classList.contains('input-port');
                        const isDifferentNode = endNodeId !== tempConnection.startNode;

                        if (isInputPort && isDifferentNode) {

                            const isNodeInputOccupied = connections.some((c, i) => {
                                return (dragInfo.type !== 'connection_active' || dragInfo.index !== i) && c.toNode === endNodeId;
                            });
                            if (!isNodeInputOccupied) {
                                isValidTarget = true;
                            }
                        }
                    }


                    if (isValidTarget) {
                        tempConnection.path.classList.add('valid-target');
                        tempConnection.path.setAttribute('marker-end', 'url(#end-circle-valid)');
                    } else if (endPort) {
                        tempConnection.path.classList.add('invalid-target');
                        tempConnection.path.setAttribute('marker-end', 'url(#end-circle-invalid)');
                    } else {
                        tempConnection.path.setAttribute('marker-end', 'url(#end-circle-temp)');
                    }
                }
            }

            function onMouseUp(e) {
                if (tempConnection.active) {
                    const endPort = e.target.closest('.node-port');
                    let isValidTarget = false;
                    if (endPort && window.getComputedStyle(endPort).visibility === 'visible') {
                        const endNodeId = endPort.closest('.workflow-node').id;
                        const isInputPort = endPort.classList.contains('input-port');
                        const isDifferentNode = endNodeId !== tempConnection.startNode;
                        if (isInputPort && isDifferentNode) {
                            const isNodeInputOccupied = connections.some((c, i) => (dragInfo.type !== 'connection_active' || dragInfo.index !== i) && c.toNode === endNodeId);
                            if (!isNodeInputOccupied) isValidTarget = true;
                        }
                    }
                    if (isValidTarget) {
                        const newConnection = { fromNode: tempConnection.startNode, fromPort: tempConnection.startPort, toNode: endPort.closest('.workflow-node').id, toPort: endPort.dataset.portName };
                        if (dragInfo.type === 'connection_active') {
                            connections.splice(dragInfo.index, 1, newConnection);
                        } else {
                            connections.push(newConnection);
                        }
                    } else if (dragInfo.type === 'connection_active') {

                        connections.splice(dragInfo.index, 1);
                    }

                    if (tempConnection.path) {
                        tempConnection.path.remove();
                        tempConnection.path = null;
                    }
                    tempConnection.active = false;


                    document.querySelectorAll('.workflow-node').forEach(node => {
                        if (!node.classList.contains('selected-node')) {
                            node.classList.remove('show-ports');
                        }
                    });


                    renderNodes();
                    applyTransform();
                    renderConnections();
                    if (!isTesting) renderPropertiesPanel();


                    setTimeout(() => {
                        renderConnections();
                    }, 10);
                }
                dragInfo = {};


                if (!tempConnection.active) {
                    document.querySelectorAll('.workflow-node').forEach(node => {

                        if (!node.classList.contains('selected-node')) {
                            node.classList.remove('show-ports');
                        }
                    });
                }

                if (isPanning) {
                    isPanning = false;
                    canvasContainer.classList.remove('panning');
                }
            }

            function renderAll(data = null) {
                if (data) {
                    nodes = data.nodes;
                    connections = data.connections;
                }
                renderNodes();
                applyTransform();
                renderConnections();
                if (!isTesting) renderPropertiesPanel();
            }

            function onNodeMouseDown(e, node) {
                if (isTesting || e.target.classList.contains('node-port') || isSpacePressed) return;
                selectedNodeId = node.id;


                document.querySelectorAll('.workflow-node').forEach(n => {
                    if (n.id === node.id) {
                        n.classList.add('show-ports');
                    } else {
                        n.classList.remove('show-ports');
                    }
                });

                const rect = canvasContainer.getBoundingClientRect();
                dragInfo = { type: 'node', target: node, offsetX: (e.clientX - rect.left - panX) / scale - node.x, offsetY: (e.clientY - rect.top - panY) / scale - node.y };
                renderAll();
            }

            function onPortMouseDown(e) {
                e.stopPropagation();
                if (isTesting || isSpacePressed) return;
                const port = e.currentTarget;
                const startNodeId = port.closest('.workflow-node').id;
                const startPortName = port.dataset.portName;
                const startNode = nodes.find(n => n.id === startNodeId);
                if (!port.classList.contains('output-port')) return;
                const isStandardNode = !['if', 'forEach'].includes(startNode.type);
                if (isStandardNode) {
                    if (connections.some(c => c.fromNode === startNodeId)) return;
                } else {
                    if (connections.some(c => c.fromNode === startNodeId && c.fromPort === startPortName)) return;
                }
                tempConnection.active = true;
                tempConnection.startNode = startNodeId;
                tempConnection.startPort = startPortName;


                document.querySelectorAll('.workflow-node').forEach(node => {
                    node.classList.add('show-ports');
                });
                const startPos = getPortPosition(tempConnection.startNode, tempConnection.startPort);
                if (!startPos) return;
                if (tempConnection.path) {
                    tempConnection.path.remove();
                }
                tempConnection.path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempConnection.path.setAttribute('d', drawCurve(startPos.x, startPos.y, startPos.x, startPos.y));
                tempConnection.path.classList.add('connector-path-temp');
                tempConnection.path.setAttribute('marker-end', 'url(#end-circle-temp)');
                tempConnection.path.style.pointerEvents = 'none';
                svg.appendChild(tempConnection.path);
            }

            function onConnectionPathMouseDown(e, connectionToModify, index) {
                e.preventDefault();
                e.stopPropagation();
                if (isTesting || isSpacePressed) return;
                dragInfo = { type: 'connection', index: index, connection: connectionToModify, startX: e.clientX, startY: e.clientY };
            }

            function openSelectorTool(inputId) {
                activeSelectorInputId = inputId;
                selectorPasteArea.value = '';

                const startNode = nodes.find(n => n.id === selectedNodeId);
                let targetUrl = '';


                const gotoNode = nodes.find(n => n.type === 'goto');
                if (gotoNode && gotoNode.params.url) {
                    targetUrl = gotoNode.params.url;
                    selectorUrlInput.value = targetUrl;
                    urlNotFoundMsg.classList.add('hidden');
                    openUrlBtn.disabled = false;
                } else {
                    selectorUrlInput.value = 'Không tìm thấy URL';
                    urlNotFoundMsg.classList.remove('hidden');
                    openUrlBtn.disabled = true;
                }

                selectorModal.classList.remove('hidden');
            }

            function renderPropertiesPanel() {
                const lang = translations[currentLanguage];
                propertiesPanelContainer.innerHTML = `
                <h2 class="text-lg font-semibold mb-4 pb-2 border-b border-slate-200 dark:border-gray-700 text-slate-900 dark:text-gray-100"><i class="fas fa-sliders-h mr-2 text-slate-500 dark:text-gray-400"></i>${lang.properties}</h2>
                <div id="properties-panel" class="flex-grow overflow-y-auto"></div>`;
                const panel = document.getElementById('properties-panel');
                const node = nodes.find(n => n.id === selectedNodeId);
                if (!node) {
                    panel.innerHTML = `<p class="text-slate-500 dark:text-gray-400 text-center mt-8">${lang.selectBlockToView}</p>`;
                    return;
                }
                const actionConfig = getActionConfig();
                const config = actionConfig[node.type];
                if (!config) return;
                let formHTML = '';
                config.params.forEach(param => {
                    const value = node.params[param.id] || '';
                    const inputId = `prop-input-${node.id}-${param.id}`;
                    formHTML += `<div class="mt-4"><label for="${inputId}" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-1">${param.label}</label>`;
                    const commonClasses = "w-full px-3 py-2 border border-slate-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-slate-800 dark:text-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500";

                    if (param.type === 'select') {
                        formHTML += `<select id="${inputId}" data-param-id="${param.id}" class="${commonClasses}">`;
                        param.options.forEach(opt => formHTML += `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.text}</option>`);
                        formHTML += `</select>`;
                    } else if (param.type === 'selector') {
                        formHTML += `<div class="flex items-center space-x-2">
                        <textarea id="${inputId}" data-param-id="${param.id}" placeholder="${param.placeholder || ''}" rows="2" class="flex-grow ${commonClasses}">${value}</textarea>
                        <button class="select-element-btn p-2 text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-gray-600 rounded-md" data-target-input="${inputId}"><i class="fas fa-crosshairs text-lg"></i></button>
                    </div>`;
                    } else {
                        formHTML += `<textarea id="${inputId}" data-param-id="${param.id}" placeholder="${param.placeholder || ''}" rows="2" class="${commonClasses}">${value}</textarea>`;
                    }
                    formHTML += `</div>`;
                });
                if (node.type !== 'start') {
                    const deleteText = currentLanguage === 'vi' ? 'Xóa Khối' : 'Delete Block';
                    formHTML += `<button id="delete-node-btn" class="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md transition-colors"><i class="fas fa-trash-alt mr-2"></i>${deleteText}</button>`;
                }
                panel.innerHTML = formHTML;

                panel.querySelectorAll('textarea, select').forEach(input => {
                    input.addEventListener('input', e => {
                        node.params[e.target.dataset.paramId] = e.target.value;
                        renderNodes();
                    });
                });

                panel.querySelectorAll('.select-element-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => openSelectorTool(e.currentTarget.dataset.targetInput));
                });

                const deleteBtn = panel.querySelector('#delete-node-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (node.type === 'start') return;
                        nodes = nodes.filter(n => n.id !== selectedNodeId);
                        connections = connections.filter(c => c.fromNode !== selectedNodeId && c.toNode !== selectedNodeId);
                        selectedNodeId = null;
                        renderAll();
                    });
                }
            }

            function renderTestPanel() {
                propertiesPanelContainer.innerHTML = `
                <h2 class="text-lg font-semibold mb-4 pb-2 border-b border-slate-200 dark:border-gray-700 text-slate-900 dark:text-gray-100"><i class="fas fa-tasks mr-2 text-green-500"></i>Kết quả Test</h2>
                <pre id="panel-log-content" class="flex-grow bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-gray-200 text-sm p-2 rounded-md font-mono whitespace-pre-wrap overflow-y-auto mb-4"></pre>
                <div id="test-controls" class="flex-shrink-0 flex space-x-2">
                     <button id="stop-test-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md transition-colors"><i class="fas fa-stop mr-2"></i>Dừng</button>
                     <button id="close-test-panel-btn" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold px-4 py-2 rounded-md transition-colors hidden"><i class="fas fa-times mr-2"></i>Kết thúc</button>
                </div>`;
                document.getElementById('stop-test-btn').addEventListener('click', () => { isTestStopped = true; });
                document.getElementById('close-test-panel-btn').addEventListener('click', () => {
                    isTesting = false;
                    renderPropertiesPanel();
                });
            }

            async function startTest() {
                if (isTesting) return;
                isTesting = true;
                isTestStopped = false;
                testButton.disabled = true;
                testButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Testing...`;
                renderTestPanel();
                try {
                    await runTestSimulation();
                } catch (e) {
                    console.error("Test simulation failed:", e);
                    const logEl = document.getElementById('panel-log-content');
                    if (logEl) logEl.textContent += '\n\nLỗi nghiêm trọng xảy ra khi chạy mô phỏng.';
                } finally {
                    testButton.disabled = false;
                    testButton.innerHTML = `<i class="fas fa-play mr-2"></i>Test`;
                    const stopBtn = document.getElementById('stop-test-btn');
                    const closeBtn = document.getElementById('close-test-panel-btn');
                    if (stopBtn) stopBtn.classList.add('hidden');
                    if (closeBtn) closeBtn.classList.remove('hidden');
                }
            }

            const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

            async function runTestSimulation() {
                const logEl = document.getElementById('panel-log-content');
                let log = [];
                const startNode = nodes.find(n => n.type === 'start');
                if (!startNode) {
                    logEl.textContent = "Lỗi: Không tìm thấy khối 'Bắt đầu'.";
                    return;
                }
                logEl.textContent = "Bắt đầu mô phỏng...\n";
                let currentNode = startNode;
                let visitedCount = {};
                while (currentNode && !isTestStopped) {
                    visitedCount[currentNode.id] = (visitedCount[currentNode.id] || 0) + 1;
                    if (visitedCount[currentNode.id] > 50) {
                        log.push(`\n⚠️ Dừng lại do vòng lặp vô hạn có thể xảy ra tại khối ${currentNode.id}`);
                        break;
                    }
                    const nodeEl = document.getElementById(currentNode.id);
                    if (nodeEl) nodeEl.classList.add('ring-2', 'ring-green-500');
                    const actionConfig = getActionConfig();
                    const config = actionConfig[currentNode.type];
                    log.push(`\n▶️ [${config.name}]`);
                    Object.entries(currentNode.params).forEach(([key, val]) => {
                        if (val) log.push(`   - ${key}: ${val}`);
                    });
                    logEl.textContent = log.join('\n');
                    logEl.scrollTop = logEl.scrollHeight;
                    await sleep(700);
                    let nextNodeId = null;
                    if (currentNode.type === 'if') {
                        const thenConn = connections.find(c => c.fromNode === currentNode.id && c.fromPort === 'then');
                        if (thenConn) {
                            nextNodeId = thenConn.toNode;
                            log.push(`   -> Rẽ nhánh THEN (mô phỏng)`);
                        }
                    } else {
                        const connection = connections.find(c => c.fromNode === currentNode.id);
                        if (connection) nextNodeId = connection.toNode;
                    }
                    if (nodeEl) nodeEl.classList.remove('ring-2', 'ring-green-500');
                    if (currentNode.type === 'stop') {
                        log.push('⏹️ Luồng đã dừng tại khối Stop.');
                        nextNodeId = null;
                    }
                    currentNode = nodes.find(n => n.id === nextNodeId);
                }
                if (isTestStopped) {
                    log.push('\n\n⏹️ Người dùng đã dừng mô phỏng.');
                } else if (!currentNode && !log.some(l => l.includes('⏹️'))) {
                    log.push('\n\n✅ Mô phỏng hoàn tất.');
                }
                logEl.textContent = log.join('\n');
                logEl.scrollTop = logEl.scrollHeight;
            }

            function applyTransform() {
                transformContainer.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
            }

            document.querySelectorAll('.action-card').forEach(card => card.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.currentTarget.dataset.actionType)));
            canvasContainer.addEventListener('dragover', e => e.preventDefault());
            canvasContainer.addEventListener('drop', e => {
                e.preventDefault();
                const type = e.dataTransfer.getData('text/plain');
                const rect = canvasContainer.getBoundingClientRect();
                const x = (e.clientX - rect.left - panX) / scale;
                const y = (e.clientY - rect.top - panY) / scale;
                const newNode = createNode(type, x - 110, y - 40);
                nodes.push(newNode);
                selectedNodeId = newNode.id;
                renderAll();
            });
            canvasContainer.addEventListener('wheel', e => {
                e.preventDefault();
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const oldScale = scale;


                if (e.ctrlKey || e.metaKey) {
                    const zoom = e.deltaY > 0 ? 0.9 : 1.1;
                    scale = Math.max(0.2, Math.min(3, scale * zoom));

                    panX = mouseX - (mouseX - panX) * (scale / oldScale);
                    panY = mouseY - (mouseY - panY) * (scale / oldScale);
                } else {

                    panX += e.deltaX * -1;
                    panY += e.deltaY * -1;
                }

                applyTransform();
            });
            canvasContainer.addEventListener('mousedown', e => {
                if (isSpacePressed || e.button === 1) {
                    isPanning = true;
                    panStart.x = e.clientX;
                    panStart.y = e.clientY;
                    canvasContainer.classList.add('panning');
                }
            });
            window.addEventListener('keydown', e => {
                if (e.code === 'Space' && !isSpacePressed) {
                    e.preventDefault();
                    isSpacePressed = true;
                    canvasContainer.classList.add('pannable');
                }
            });
            window.addEventListener('keyup', e => {
                if (e.code === 'Space') {
                    isSpacePressed = false;
                    isPanning = false;
                    canvasContainer.classList.remove('pannable', 'panning');
                }
            });
            clearButton.addEventListener('click', () => {
                const confirmText = currentLanguage === 'vi' ? 'Bạn có chắc muốn xóa toàn bộ luồng công việc?' : 'Are you sure you want to clear the entire workflow?';
                if (confirm(confirmText)) init();
            });
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            canvasContainer.addEventListener('click', e => {
                if (isTesting) return;
                if (e.target === canvasContainer || e.target === transformContainer) {
                    selectedNodeId = null;

                    document.querySelectorAll('.workflow-node').forEach(node => {
                        node.classList.remove('show-ports');
                    });
                    renderAll();
                }
            });
            exportButton.addEventListener('click', () => {
                const dataStr = JSON.stringify({ nodes, connections, panX, panY, scale }, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = 'workflow.json';
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });
            importButton.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data && data.nodes && data.connections) init(data);
                        else {
                            const errorText = currentLanguage === 'vi' ? 'Tệp JSON không hợp lệ.' : 'Invalid JSON file.';
                            alert(errorText);
                        }
                    } catch (error) {
                        const errorText = currentLanguage === 'vi' ? 'Lỗi khi đọc tệp: ' : 'Error reading file: ';
                        alert(errorText + error.message);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            testButton.addEventListener('click', startTest);


            closeSelectorModalBtn.addEventListener('click', () => selectorModal.classList.add('hidden'));
            openUrlBtn.addEventListener('click', () => {
                const url = selectorUrlInput.value;
                if (url && url !== 'Không tìm thấy URL') window.open(url, '_blank');
            });
            confirmSelectorBtn.addEventListener('click', () => {
                const selectedNode = nodes.find(n => n.id === selectedNodeId);
                const targetInput = document.getElementById(activeSelectorInputId);
                if (selectedNode && targetInput) {
                    targetInput.value = selectorPasteArea.value;
                    const paramId = targetInput.dataset.paramId;
                    selectedNode.params[paramId] = selectorPasteArea.value;
                    renderNodes();
                }
                selectorModal.classList.add('hidden');
            });

            function init(initialData = null) {
                const data = initialData || { nodes: [createNode('start', 200, 150)], connections: [], panX: 0, panY: 0, scale: 1 };
                panX = data.panX || 0;
                panY = data.panY || 0;
                scale = data.scale || 1;
                nodes = data.nodes;
                connections = data.connections;
                selectedNodeId = data.nodes[0]?.id || null;
                renderAll();
            }

            init();

            document.querySelectorAll('details').forEach(detail => {
                const marker = detail.querySelector('.details-marker');
                detail.addEventListener('toggle', () => marker.classList.toggle('rotate-90', detail.open));
                if (detail.open) marker.classList.add('rotate-90');
            });
        });
    </script>
</body>

</html>